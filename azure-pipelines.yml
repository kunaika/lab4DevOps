trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  artifactName: 'my-app-artifact'
  buildConfiguration: 'Release'

stages:

# 1. Build Stage
- stage: Build
  displayName: 'Build the project'
  jobs:
  - job: BuildJob
    displayName: 'Build the project artifact'
    steps:
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet
      
    - task: DotNetCoreCLI@2
      displayName: 'Restore dependencies'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'
      
    - task: DotNetCoreCLI@2
      displayName: 'Build the project'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Publish the project'
      inputs:
        command: 'publish'
        projects: '**/*.csproj'
        publishWebProjects: false
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(artifactName)'
        
    - task: PublishBuildArtifacts@1
      displayName: 'Publish artifact'
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)/$(artifactName)
        ArtifactName: $(artifactName)
        publishLocation: 'Container'

# 2. Deliver Stage
- stage: Deliver
  displayName: 'Release artifact to deploy'
  dependsOn: Build
  jobs:
  - job: DeliverJob
    displayName: 'Release artifact'
    steps:
    - download: current
      artifact: $(artifactName)

# 3. Deploy to Dev Environment
- stage: DeployToDev
  displayName: 'Deploy to Dev Environment'
  dependsOn: Deliver
  jobs:
  - job: DeployDevJob
    displayName: 'Deploy artifact to Dev'
    steps:
    - task: AzureWebApp@1
      displayName: 'Deploy to Azure Dev Environment'
      inputs:
        appName: '$(azureDevAppName)'
        package: $(Pipeline.Workspace)/$(artifactName)/*.zip
        deploymentMethod: 'auto'
        appSettings: '-key value'

# 4. Deploy to QA Environment
- stage: DeployToQA
  displayName: 'Deploy to QA Environment'
  dependsOn: DeployToDev
  jobs:
  - job: DeployQAJob
    displayName: 'Deploy artifact to QA'
    steps:
    - task: AzureWebApp@1
      displayName: 'Deploy to Azure QA Environment'
      inputs:
        appName: '$(azureQAAppName)'
        package: $(Pipeline.Workspace)/$(artifactName)/*.zip
        deploymentMethod: 'auto'
        appSettings: '-key value'

# 5. Deploy to Staging Environment
- stage: DeployToStaging
  displayName: 'Deploy to Staging Environment'
  dependsOn: DeployToQA
  jobs:
  - job: DeployStagingJob
    displayName: 'Deploy artifact to Staging'
    steps:
    - task: AzureWebApp@1
      displayName: 'Deploy to Azure Staging Environment'
      inputs:
        appName: '$(azureStagingAppName)'
        package: $(Pipeline.Workspace)/$(artifactName)/*.zip
        deploymentMethod: 'auto'
        appSettings: '-key value'

# 6. Deploy to Production Environment
- stage: DeployToProd
  displayName: 'Deploy to Production Environment'
  dependsOn: DeployToStaging
  jobs:
  - job: DeployProdJob
    displayName: 'Deploy artifact to Production'
    steps:
    - task: AzureWebApp@1
      displayName: 'Deploy to Azure Production Environment'
      inputs:
        appName: '$(azureProdAppName)'
        package: $(Pipeline.Workspace)/$(artifactName)/*.zip
        deploymentMethod: 'auto'
        appSettings: '-key value'
